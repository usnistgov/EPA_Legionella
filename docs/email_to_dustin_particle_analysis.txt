Subject: Particle Decay Analysis Methodology and Data Processing Summary

Hi Dustin,

I wanted to provide you with a detailed explanation of how the particle decay analysis works, what validation checks are in place, and how to interpret the figures. This should help you understand what the data represents and how the key metrics are calculated.

================================================================================
OVERVIEW
================================================================================

The particle_decay_analysis.py script analyzes particle concentration data from QuantAQ MODULAIR-PM sensors to calculate three key metrics for seven particle size bins:

    1. Penetration Factor (p) - How much outdoor particles get inside
    2. Deposition Rate (beta) - How fast particles settle/deposit indoors
    3. Emission Rate (E) - How many particles the shower emits

The analysis uses a numerical approach to solve the mass balance equation for indoor particle concentration.

================================================================================
PARTICLE SIZE BINS ANALYZED
================================================================================

The Alphasense OPC-N3 sensor in the QuantAQ units provides particle counts in these size ranges:

    Bin 0: 0.35 - 0.46 micrometers
    Bin 1: 0.46 - 0.66 micrometers
    Bin 2: 0.66 - 1.0 micrometers
    Bin 3: 1.0 - 1.3 micrometers
    Bin 4: 1.3 - 1.7 micrometers
    Bin 5: 1.7 - 2.3 micrometers
    Bin 6: 2.3 - 3.0 micrometers

Each bin is analyzed independently, allowing us to see size-dependent behavior in particle transport and deposition.

================================================================================
DATA SOURCES AND DEPENDENCIES
================================================================================

The analysis requires several input data sources:

1. PARTICLE DATA (QuantAQ MODULAIR-PM sensors):
   - Inside sensor: Located in the bedroom
   - Outside sensor: Located outdoors for background reference
   - Files: *-quantaq-inside-processed.csv and *-quantaq-outside-processed.csv
   - Data is resampled to 1-minute intervals with linear interpolation for gaps up to 5 minutes

2. SHOWER LOG:
   - State-change log identifying when shower turned ON and OFF
   - Used to define analysis windows
   - Generated by scripts/process_shower_log.py

3. CO2 ANALYSIS RESULTS (CRITICAL DEPENDENCY):
   - The particle analysis REQUIRES air change rate (lambda) values from CO2 decay analysis
   - This must be run first: python src/co2_decay_analysis.py
   - Lambda values come from co2_lambda_summary.csv in the output folder

4. EVENT MANAGEMENT SYSTEM:
   - Filters events to only include dates >= January 14, 2026 (experiment start)
   - Assigns test condition names (e.g., 0114_HW_Morning_R01)
   - Handles event exclusions (e.g., tour on January 22 at 3 PM)
   - Creates synthetic events for missing data when needed

================================================================================
THE MASS BALANCE EQUATION
================================================================================

The fundamental equation governing indoor particle concentration is:

    V * dC/dt = p*Q*C_out - Q*C - beta*V*C + E

Rearranged in terms of rates:

    dC/dt = p*lambda*C_out - lambda*C - beta*C + E/V

Where:
    V = Room volume (36 cubic meters for the bedroom)
    C = Indoor particle concentration (#/cm^3)
    C_out = Outdoor particle concentration (#/cm^3)
    p = Penetration factor (dimensionless, 0-1)
    lambda = Air change rate from CO2 analysis (h^-1)
    beta = Deposition loss rate (h^-1)
    E = Emission rate (#/minute)

================================================================================
CALCULATION METHODOLOGY
================================================================================

For each shower event, the analysis proceeds in three phases:

--- PHASE 1: PENETRATION FACTOR (p) ---

Time Window: 1 hour BEFORE shower starts
Purpose: Measure the ratio of indoor to outdoor particles at steady state (before shower influence)

Calculation:
    p = C_inside / C_outside (averaged over the pre-shower window)

Expected Range: 0.3 to 1.5 (typically 0.7-0.9 for well-sealed buildings)

What it means: A value of 0.8 means 80% of outdoor particles penetrate into the building. Values below 1.0 indicate some filtration by the building envelope.


--- PHASE 2: DEPOSITION RATE (beta) ---

Time Window: 2 hours AFTER shower ends
Starting Point: Analysis starts from PEAK concentration within the window, not from shower_off time

Calculation (numerical method for each time step):
    beta = 1/dt - lambda - C_t(i+1)/(C_t * dt) + (p * lambda * C_out,t) / C_t

The script also performs a linearized regression fit:
    y = -ln[(C(t) - C_ss) / (C_0 - C_ss)] = (lambda + beta) * t

Where C_ss is the steady-state concentration = (p * lambda * C_out_avg) / (lambda + beta)

Maximum Allowed Value: 15 h^-1

What it means: Higher beta means particles are removed from the air faster (through settling, diffusion to surfaces, etc.). Larger particles typically have higher deposition rates due to gravitational settling.


--- PHASE 3: EMISSION RATE (E) ---

Time Window: From shower ON to shower OFF
Prerequisites: Valid p and beta values must exist

Calculation (numerical method for each time step):
    E = p*lambda*V*C_out,t + V*(C_t - C_t+1)/dt - lambda*V*C_t - beta*V*C_t

Units: particles per minute (#/min)

What it means: This is the rate at which the shower is generating aerosolized particles. Higher values indicate more particle production, which is relevant for understanding potential pathogen exposure.

================================================================================
VALIDATION CHECKS AND THRESHOLDS
================================================================================

The analysis includes multiple validation checks to ensure data quality:

1. MINIMUM DATA POINTS:
   - Penetration calculation: At least 10 valid data points required
   - Deposition calculation: At least 10 data points after peak
   - Emission calculation: At least 3 data points during shower
   - Valid beta values: At least 5 reasonable values required

2. PENETRATION FACTOR BOUNDS:
   - Minimum p: 0.3 (values below suggest measurement issues)
   - Maximum p: 1.5 (values above suggest indoor sources)
   - Points outside this range are excluded from averaging

3. CONCENTRATION RATIO CHECK:
   - For deposition: C_inside/C_outside at peak must exceed 1.05
   - This ensures there's actually an elevated concentration to analyze

4. DEPOSITION RATE BOUNDS:
   - Maximum beta: 15 h^-1 (values above are unrealistic)
   - Minimum beta: 0 (negative values are excluded)

5. EMISSION RATE CHECK:
   - Only positive emission values are kept
   - Negative values indicate the model assumptions aren't met

6. EVENT EXCLUSIONS:
   - Pre-experiment dates (before January 14, 2026)
   - Specific excluded events (e.g., tour on 2026-01-22 at 15:00)
   - Events without matching CO2 lambda values

================================================================================
EVENT NAMING CONVENTION
================================================================================

Each event is named following this format: MMDD_TempCode_TimeOfDay_RNN

Components:
    MMDD = Month and day (e.g., 0114 for January 14)
    TempCode = HW (Hot Water, before Jan 22 2PM) or CW (Cold Water, after)
    TimeOfDay = Morning (5am-11am), Afternoon (11am-5pm), Evening (5pm-9pm), or Night (9pm-5am)
    RNN = Replicate number (R01, R02, etc.)

Examples:
    0114_HW_Morning_R01 = January 14, Hot Water, Morning, First replicate
    0122_CW_Afternoon_R03 = January 22, Cold Water, Afternoon, Third replicate

If the bath fan ran during the test, "_Fan" is added (e.g., 0120_HW_Evening_Fan_R01)

================================================================================
EVENT MATCHING (SHOWER TO CO2)
================================================================================

The experimental protocol follows this sequence:
    1. CO2 injection at :40 (e.g., 08:40)
    2. CO2 injection ends at :44 (4-minute injection)
    3. Mixing fan turns off at :45
    4. Shower ON at :00 of next hour (e.g., 09:00)
    5. Shower OFF after 5-15 minutes
    6. CO2 decay measurement starts at :50

CO2 injection occurs approximately 20 minutes BEFORE the shower starts. The matching algorithm looks for CO2 events within +/- 10 minutes of the expected injection time (shower_time - 20 minutes).

================================================================================
OUTPUT FILES
================================================================================

The analysis generates these outputs in the data/output folder:

1. particle_analysis_summary.xlsx (Multi-sheet workbook):
   - all_results: Complete results for all events and bins
   - p_penetration: Penetration factors per event and bin
   - beta_deposition: Deposition rates per event and bin
   - beta_r_squared: R-squared values for deposition fits
   - E_emission: Emission rates per event and bin

2. event_log.csv:
   - Complete log of all events with matching status
   - Exclusion flags and reasons
   - Test condition names

3. Plots (in output/plots folder):
   - event_XX-MMDD_temp_timeofday_pm_decay.png: Individual event decay curves
   - penetration_summary.png: Bar chart of p values by particle size
   - deposition_summary.png: Bar chart of beta values by particle size
   - emission_summary.png: Bar chart of E values by particle size

================================================================================
INTERPRETING THE FIGURES
================================================================================

INDIVIDUAL EVENT PLOTS (Two panels):

Top Panel - Concentration Time Series:
    - Each colored line represents a different particle size bin
    - Solid lines = bins with valid analysis results
    - Dashed lines = bins that failed validation (insufficient data, etc.)
    - Blue shaded region = Pre-shower window used for penetration calculation
    - Orange shaded region = Post-shower window used for deposition calculation
    - Vertical green line = Shower ON time
    - Vertical red line = Shower OFF time
    - Y-axis is logarithmic scale
    - Text box shows lambda value and count of valid bins

Bottom Panel - Linearized Regression:
    - Shows the linearized transformation used to calculate beta
    - Y-axis: -ln[(C(t) - C_ss) / (C_0 - C_ss)]
    - X-axis: Time since decay start (hours)
    - Scattered points = actual data
    - Lines = linear regression fits
    - Slope of each line = lambda + beta
    - Legend shows beta and R-squared for each bin


SUMMARY BAR CHARTS:

Penetration Summary:
    - Mean +/- standard deviation across all events
    - Horizontal dashed lines at 0.7 and 0.9 show expected range
    - Lower values for larger particles expected (less penetration)

Deposition Summary:
    - Mean +/- standard deviation across all events
    - Higher values for larger particles expected (more gravitational settling)

Emission Summary:
    - Mean +/- standard deviation across all events
    - May use logarithmic scale if range is large
    - Size distribution indicates particle generation characteristics

================================================================================
PHYSICAL INTERPRETATION
================================================================================

What the results tell us:

1. PENETRATION (p):
   - Building envelope effectiveness at filtering outdoor particles
   - Size-dependent: larger particles are filtered more effectively
   - Typical range: 0.7-0.9 for most buildings

2. DEPOSITION (beta):
   - Surface loss rate of airborne particles
   - Includes: gravitational settling, diffusion to surfaces, adhesion
   - Size-dependent: larger particles settle faster (Stokes settling)
   - Typical range: 0.1-5 h^-1 depending on particle size

3. EMISSION (E):
   - Particle generation rate from the shower
   - Relevant for exposure assessment to waterborne pathogens
   - Size distribution can indicate aerosolization mechanisms
   - Higher flow rates and hotter water typically increase emissions

================================================================================
QUALITY CONTROL NOTES
================================================================================

Events are flagged or excluded if:
    - Skip reason column populated in the output files
    - Insufficient data points in analysis windows
    - Concentration ratios outside expected bounds
    - Missing CO2 lambda values (dependency on CO2 analysis)

Always check the skip_reason columns in the output to understand why specific bins or events may have failed analysis.

================================================================================

Let me know if you have any questions about the methodology or need clarification on any of the figures!

Best,
Nathan

--------------------------------------------------------------------------------
Nathan Lima
National Institute of Standards and Technology (NIST)
January 2026
